global
        daemon

defaults
        log global
        mode tcp
        option tcplog

        option dontlognull
        #maxconn 2000
        timeout connect 24h
        timeout client 24h
        timeout server 24h

frontend ssl
        mode tcp
        bind *:443 ssl crt /etc/letsencrypt/live/v.opinion.works/v.haproxy.pem
        tcp-request inspect-delay 5s
        tcp-request content accept if { req.ssl_hello_type 1 }

        acl tls req.ssl_hello_type 1
        acl has_sni req.ssl_sni -m found
        acl ssh_payload payload(0,7) -m bin 5353482d322e30


        use_backend v2ray if tls { req.ssl_sni -i v.opinion.works }
        default_backend nginx

backend v2ray
        mode tcp
        server v2ray v2ray:80 send-proxy

backend nginx
        mode tcp
        server nginx nginx:80 send-proxy