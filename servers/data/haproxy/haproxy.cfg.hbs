global
        daemon
        log stdout format raw daemon

defaults
        log global
        mode tcp
        option tcplog

        option dontlognull
        #maxconn 2000
        timeout connect 24h
        timeout client 24h
        timeout server 24h

frontend ssl
        mode tcp
        bind *:443 ssl crt /etc/letsencrypt/haproxy.pem tfo
        log-format "%ci:%cp [%t] %ft %b/%s %Tw/%Tc/%Tt %B %ts %ac/%fc/%bc/%sc/%rc %sq/%bq ssl_fc_has_sni '%[ssl_fc_has_sni]' sni:'%[capture.req.hdr(0)]' ssl_fc_sni '%[ssl_fc_sni]' ssl_fc_protocol '%[ssl_fc_protocol]' ssl_bc '%[ssl_bc]' ssl_bc_alpn '%[ssl_bc_alpn]' ssl_bc_protocol '%[ssl_bc_protocol]' ssl_c_i_dn '%[ssl_c_i_dn()]' ssl_c_s_dn '%[ssl_c_s_dn()]' ssl_f_i_dn '%[ssl_f_i_dn()]' ssl_f_s_dn '%[ssl_f_s_dn]' ssl_fc_cipher '%[ssl_fc_cipher]' "
        tcp-request inspect-delay 5s
	acl is_https req.payload(0,3) -m bin 160301
	use_backend nginx if is_https
	{{#each protocols}}
        use_backend {{name}} if { ssl_fc_sni -i {{server.address}}  } !is_https
	{{/each}}
        default_backend nginx

{{#each protocols}}
backend {{name}}
	mode tcp
	server {{name}} {{name}}:{{server.port}}
{{/each}}

backend nginx
        mode tcp
        server nginx nginx:80 send-proxy-v2 tfo