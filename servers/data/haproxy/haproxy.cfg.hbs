global
        daemon
        log stdout format raw daemon

defaults
        log global
        mode tcp
        option tcplog

        option dontlognull
        #maxconn 2000
        timeout connect 5s
        timeout client 300s
        timeout server 300s

	http-reuse safe

frontend tcp_in
	mode tcp
        bind *:443 alpn h2,http/1.1
        tcp-request inspect-delay 5s
	acl is_https req.payload(0,3) -m bin 160301
	use_backend https if is_https
        default_backend tcp

frontend https
	mode tcp
	bind abns@/var/run/https.sock accept-proxy ssl crt /etc/letsencrypt/haproxy.pem tfo
	{{#each protocols}}
	use_backend {{name}} if { ssl_fc_sni -i {{server.address}}  }
	{{/each}}
	default_backend http

frontend tcp
	mode tcp
	bind abns@/var/run/tcp.sock accept-proxy ssl crt /etc/letsencrypt/haproxy.pem tfo
	{{#each protocols}}
	use_backend {{name}} if { ssl_fc_sni -i {{server.address}}  }
	{{/each}}

backend tcp
	mode tcp
	server tcp abns@/var/run/tcp.sock send-proxy-v2 tfo

backend https
        mode tcp
	server https abns@/var/run/https.sock send-proxy-v2 tfo

{{#each protocols}}
backend {{name}}
	mode tcp
	server {{name}} {{name}}:{{server.port}}
{{/each}}

backend http
	mode tcp
	server nginx nginx:80 send-proxy-v2 tfo